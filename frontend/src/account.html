<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Main Page</title>
    <link rel="stylesheet" href="../style/styles.css">
    <style>
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .action-buttons button {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th, table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        table th {
            background-color: #f0f4f8;
            font-weight: 600;
        }

        table tr:hover {
            background-color: #f9fbfd;
        }

        .table-container {
            margin-top: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
    </style>
    <script>
        function show_transactions(transactions)
        {
            document.getElementById("transaction_table").innerHTML = '';
            console.log(transactions.length);
            console.log(transactions);
            if(transactions.length == 0)
            {
                document.getElementById("transaction_table").innerHTML = "<tr><td colspan='4'>No transactions found.</td></tr>";
                return;
            }
            for(i = transactions.length - 1; i >= 0; i--)
            {
                let new_line = "<tr><td>" + transactions[i].date +"</td><td>" + transactions[i].description + "</td><td>" + transactions[i].amount + "</td><td>" + transactions[i].type + "</td></tr>";
                document.getElementById("transaction_table").innerHTML += new_line;
            }
        }

        async function update_user_data()
        {
            return fetch("http://127.0.0.1:5000/api/get_user_data", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "user_id": localStorage.getItem("account_number"), 
                        })
                    }
                ).then(res => res.json()).then(data => {
                    if(data.status == false)
                    {
                        alert(data.text);
                        return false;
                    }
                    else 
                    {
                        document.getElementById("balance").innerHTML = data.balance;
                        show_transactions(data.transactions);
                        return true;
                    }
                });
        }
    
        function insert_transaction(description, amount, type)
        {
            today = new Date();

            let new_line = "<tr><td>" + today.toISOString().split("T")[0] +"</td><td>" + description + "</td><td>" + amount + "</td><td>" + type + "</td></tr>";

            document.getElementById("transaction_table").innerHTML = new_line + document.getElementById("transaction_table").innerHTML;
        }

        function withdraw_money()
        {
            amount = parseFloat(prompt("Please enter the amount to withdraw"));
            description = prompt("Please enter the description");

            return fetch("http://127.0.0.1:5000/api/withdraw", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "user_id": localStorage.getItem("account_number"), 
                            "amount": amount,
                            "description": description
                        })
                    }
                ).then(res => res.json()).then(data => {
                    if(data.status == false)
                    {
                        alert(data.text);
                        return false;
                    }
                    else 
                    {
                        alert("Withdrawal successful!")
                        show_transactions(data.transactions);
                        document.getElementById("balance").innerHTML = data.balance;
                        return true;
                    }
                });
        }

        window.onload = async function() {
            let accountNumber = localStorage.getItem("account_number");
            document.getElementById("account_number").innerText = accountNumber;
            await update_user_data();
        };
    </script>
</head>
<body>
    <form>
        <h1 class="main_header">My Account - <label id="account_number"></label></h1>

        <img id="bank_img" src="../images/bank.jpg" alt="Bank Image" title="Bank Image">

        <div class="balance">Balance: $<span id="balance"></span></div>

        <div class="action-buttons">
            <button type="button" onclick="withdraw_money()">Withdraw Money</button>
            <button type="button" onclick="window.location.href = '/page/transfer';">Transfer Money</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="transaction_table">
                </tbody>
            </table>
        </div>

        <a href="/page/login">Back to login</a>
    </form>
</body>
</html>
